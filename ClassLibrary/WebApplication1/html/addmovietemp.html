<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title>הוספת סרט</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="stylesheet.css">

    <script>
            var user = JSON.parse(localStorage.getItem("user"));
            var numOfProj = 0;
            var max_projection = 5;
            var allProj = [];

            $(document).ready(function () {
                document.getElementById("publish_date").value = new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60 * 1000).toISOString().substr(0, 10);
                if (user != null) { //There is a user
                    ifUser = 1;
                    var $div = document.getElementById("hello");
                    var $spn = $("<span>").innerHTML = "שלום " + user.name;
                    $div.append($spn);
                    var $logOut = $("<button>").text("התנתק").attr("class", "w3-bar-item w3-button w3-padding-large  w3-text-white").click(function () { logout() });
                    var $view = $("<button>").text("צפייה בהזמנות שלי").attr("class", "w3-bar-item w3-button w3-padding-large  w3-text-white").click(function () { location.href = 'userOrders.html' });
                    $("#btn").append($logOut);
                    $("#btn").append($view);

                }
                else { //No user exists
                    ifUser = 0;
                    var $div = document.getElementById("hello");
                    var $spn = $("<span>").innerHTML = "גישה למנהלים בלבד";
                    $div.append($spn);
                    var $con = $("<button>").text("התחבר").attr("class", "w3-bar-item w3-button w3-padding-large  w3-text-white").click(function () { location.href = 'login.html' });
                    var $reg = $("<button>").text("הרשמה").attr("class", "w3-bar-item w3-button w3-padding-large  w3-text-white").click(function () { location.href = 'addUser.html' });
                    $("#btn").append($con);
                    $("#btn").append($reg);


                }
            });

            function addMovie()
            {
                var movie = {
                    name: $("#name").val(),
                    publish_date: $("#publish_date").val(),
                    langth: $("#langth").val(),
                    genre: $('#genre').find(":selected").text()
                };

                var fd = new FormData();
                // append movie
                var movie_string = JSON.stringify(movie);
                fd.append("movie", movie_string);

                // append image
                fd.append("img", $("#imgInp")[0].files[0]);

                // append PlayTime data
                fd.append("numOfProj", numOfProj);
                fd.append("sits", $("#sits").val());
                for (var i = 0; i < numOfProj; i++)
                    fd.append("projection" + i, $("#projection" + i).val());

                // send all data
                $.ajax({
                    url: "/api/Movie",
                    type: "PUT",
                    data: fd,
                    contentType: false,
                    processData: false,
                    success: function ()
                    {
                        setTimeout(function(){
                            alert("הסרט נוסף בהצלחה!");
                        }
                            , 10);
                        location.reload();
                    },
                    error: function (xhr, textStatus, errorThrown)
                    {
                        var error = JSON.parse(xhr.responseText).Message;
                        if (error != "חסרים נתונים בסרט")
                            alert();
                    }
                });
            }


            function addProjection() {
                if (numOfProj < max_projection)
                {
                    if (numOfProj == 0)
                    {
                        $("#projection").empty();
                    }
                    var d = document.createElement("div");
                    d.style.margin = "5px";


                    var dateTime = document.createElement("input");
                    dateTime.type = "datetime-local";
                    dateTime.required = true;
                    dateTime.value = (new Date().toJSON().slice(0,19));
                    dateTime.id = "projection" + numOfProj;

                    var spn = document.createElement("span");
                    numOfProj++;
                    spn.innerHTML = numOfProj + ".";

                    var list = document.getElementById("projection");

                    d.appendChild(spn);
                    d.appendChild(dateTime);
                    list.appendChild(d);
                }
            }


            $(document).ready(function ()
            {
               var list = document.getElementById("projection");
                var d = document.createElement("div");
                d.style.margin = "5px";
                var spn = document.createElement("span");
                spn.innerHTML = "לא הוכנסו הקרנות";
                d.appendChild(spn);
                list.appendChild(d);
            })


            function readURL(input) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById('imgshow').src = e.target.result;
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            }
            function logout() {
                localStorage.clear();
                location.href = 'login.html';
            }

    </script>
</head>

<body dir="rtl">

    <!--Top menu-->
    <div class="w3-bar w3-card-2">
        <button onclick=" location.href = 'showAll.html'" class="w3-bar-item w3-button w3-padding-large  w3-text-white"><i class=" material-icons">home</i></button>
        <div id="btn"></div>
        <!--<button class="w3-bar-item w3-button w3-padding-large  w3-text-white"><i class=" material-icons">search</i></button>-->
        <div class="w3-text-white" id="hello"></div>
    </div>

    <form>

        <table id="bigTbl" align="center">
            <tr>
                <td colspan="5">
                    <h4 id="addMovie" class="w3-large  w3-round w3-green w3-border w3-border-white">הוספת סרט חדש</h4>
                </td>
            </tr>
            <tr class="w3-panel w3-pale-green w3-bottombar w3-border-green w3-border ">
                <td>
                    <img id="imgshow" src="/images/first_img.JPG" />
                </td>

                <td>
                    <table id="internalTbl" align="center">
                        <tr><td class="w3-text-black "> שם הסרט* </td><td><input type="text" id="name" required autofocus /></td></tr>
                        <tr><td class="w3-text-black">   מספר מקומות*</td><td><input type="text" id="sits" required /></td></tr>
                        <tr><td class="w3-text-black">    תאריך הוצאה</td><td><input type="date" id="publish_date" /></td></tr>
                        <tr>
                            <td class="w3-text-black" required>    ז'אנר*</td>
                            <td>
                                <select id="genre">
                                    <option>פעולה</option>
                                    <option>מתח</option>
                                    <option>קומדיה</option>
                                    <option>דרמה</option>
                                    <option>רומנטי</option>
                                    <option>אימה</option>
                                </select>
                            </td>
                        </tr>
                        <tr><td class="w3-text-black">  אורך הסרט בדקות*</td><td><input type="text" id="langth" required /></td></tr>
                        <tr><td class="w3-text-black"> תמונה</td><td><input type="file" id="imgInp" onchange="readURL(this);" /></td></tr>

                    </table>
                </td>

                <td class="w3-display-container">
                    <table class="w3-display-top">
                        <tr>
                            <td class="w3-text-black ">הקרנות:</td>
                            <td id="projection" align="center"></td>
                            <td align="center" class=""> <input type="button" value="הוסף הקרנה" onclick="addProjection()" /> </td>

                        </tr>

                    </table>
                </td>
            </tr>
            <tr>

                <td class="w3-text-white" align="center" colspan="3"></td>

            </tr>
        </table>
        <div align="center" id="submitB">
            <input type="submit" value="הוסף" class="bottomButton w3-button w3-block w3-green w3-round" onclick="addMovie()" />

        </div>


    </form>


</body>
</html>

