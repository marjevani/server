<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>ההזמנות שלי</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <style>
        .gallery td {
            padding: 5px;
            width: 200px;
            height: 200px;
            position: relative;
        }

        #bigTbl {
            border-collapse: collapse;
            margin-top: 30px;
            padding: 10px;
        }

        body {
            background-image: url("/images/background.jpg");
            background-attachment: fixed;
        }

        h4 {
            text-align: center;
            margin: 5px;
            padding: 5px;
            color: white;
            position: relative;
            width: 1100px;
        }

        .internalDiv {
            width: 200px;
            text-align: center;
        }

        img {
            width: 100px;
            height: 100px;
            margin: 5px;
        }

        #hello {
            margin: 5px;
            padding: 5px;
            border: 1px dashed black;
            display: inline;
        }

        .avi {
            margin-left: 20px;
        }

        .lowerDiv {
            text-align: center;
        }

        .adminDiv {
            display: inline;
        }

        #logOutDiv {
            top: 20px;
            position: relative;
        }
    </style>
    <script>
        var user = JSON.parse(localStorage.getItem("user"));
        var numOfAvailableSits;
        var itemInRow = 5;

        $(document).ready(function () {
            // hello messege - top
            var $spn = document.getElementById("hello");
            $spn.innerHTML = "שלום " + user.name;

            var $tbl = $("<table>").attr("class", "available");
            var $tr = $("<tr>");
            var counter = 0;

            // get and show all CustomerBuyTickets
            $.ajax({
                dataType: "json",
                url: "/api/CustomerBuyTickets/" + user.id,
                contentType: "application/json; charset=utf-8",
                type: "GET",
                success: function (data) {
                    if (data.length == 0) {
                        $h4 = $("<h4>").text("לא נמצאו הזמנות עבור לקוח");
                        $("#noOrders").append("<br>");
                        $("#noOrders").append($h4);
                    }
                    else { //data.length != 0
                        var $tdH = $("<h4>").text("  ההזמנות שלי: ").attr("class", "w3-blue head");
                        $("#tdHeader").append($tdH);
                    }

                    for (i in data) {
                        if (counter == itemInRow) {
                            $tr = $("<tr>");
                            counter = 0;
                        }
                        counter++;
                        var $td = $("<td>").attr("class", "w3-white");
                        var $div = $("<div>").attr({ "class": "internalDiv", "data-id": data[i].id })// "data-id": data[i].Movie.id });
                        var $nameP = $("<span>").attr("data-name", data[i].Movie.name).text("שם הסרט:" + data[i].Movie.name);
                        date = new Date(data[i].PlayTime.play);
                        var $time = $("<span>").html("זמן הקרנה:" + date.toLocaleString('en-GB'));
                        var $orders = $("<span>").html("מספר כרטיסים:" + data[i].amount);

                        var $pic = $("<img>").attr({ "src": "/images/" + data[i].Movie.img, "movie-number-pic": i + 1 });
                        var $btn = $("<button>").text("בטל הזמנה").click(function () { deleteOrder(this) });


                        $div.append($nameP);
                        $div.append($("<br>"));
                        $div.append($time);
                        $div.append($("<br>"));
                        $div.append($orders);
                        $div.append($("<br>"));
                        $div.append($("<br>"));
                        $div.append($("<br>"));
                        $div.append($pic);
                        $div.append($("<br>"));
                        $div.append($btn);

                        $td.append($div);
                        $tr.append($td);
                        $tbl.append($tr);
                        $("#availableTbl").append($tbl);
                    }
                },
                error: function () {
                    console.log("connection ERROR - Available movies");
                }
            });
        });

        function deleteOrder(t) {
            $.ajax({
                dataType: "json",
                url: "/api/CustomerBuyTickets/" + t.parentElement.getAttribute("data-id"),
                contentType: "application/json; charset=utf-8",
                type: "DELETE",
                success: function (data) {
                    alert("Order deleted successfully!");
                    location.reload();
                },
                error: function () { alert("error in delete"); }
            });
        }

        function logout() {
            localStorage.clear();
            location.href = 'login.html';
        }
    </script>

</head>
<body dir="rtl">

    <div id="logOutDiv">
        <input type="button" value="logOut" onclick="logout()" />
        <span class="w3-white" id="hello"></span>
        <input type="button" value="חזרה להצגת כל הסרטים" onclick="location.href = 'showAll.html'" />
    </div>

    <div id="noOrders" align="center"></div>
    <table id="bigTbl" align="center">
        <tr>
            <td colspan="5" id="tdHeader"></td>
        </tr>

        <tr class="gallery">
            <td colspan="5">
                <div class="w3-text-blue" id="availableTbl">
                </div>
            </td>
    </table>

</body>
</html>
